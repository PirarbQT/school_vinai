<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:'Prompt',sans-serif}
body{margin:0;background:#f5f7fb}
header{background:#fff;padding:16px 24px;font-weight:600;font-size:20px}
.container{display:grid;grid-template-columns:320px 1fr;gap:20px;padding:20px}
.card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
.levels button{margin:4px;padding:6px 14px;border-radius:10px;border:none;background:#eef2ff;cursor:pointer}
.levels .active{background:#2563eb;color:#fff}
.assign-item{display:flex;justify-content:space-between;margin-bottom:10px}
.btn{border:none;border-radius:8px;padding:6px 10px;cursor:pointer}
.btn-add{background:#0ea5e9;color:#fff}
.btn-del{background:#fecaca}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:center}
th{background:#e0f2fe}
input.score{width:60px;padding:6px;border-radius:8px;border:1px solid #cbd5f5;text-align:center}
.grade{padding:4px 10px;border-radius:999px;color:#fff}
.grade.A{background:#22c55e}
.grade.B{background:#10b981}
.grade.C{background:#3b82f6}
.grade.D{background:#f59e0b}
.grade.F{background:#ef4444}
</style>
</head>

<body>

<header>
üéì ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
<small style="font-weight:400;color:#64748b"> ‡∏õ.1 ‚Äì ‡∏°.6</small>
</header>

<div class="container">

<!-- ‡∏ã‡πâ‡∏≤‡∏¢ -->
<div>
  <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô -->
  <div class="card">
    <h4 id="classTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô: ‡∏õ.1</h4>
    <div class="levels">
      <button class="active" onclick="changeClass('‡∏õ.1',this)">‡∏õ.1</button>
      <button onclick="changeClass('‡∏õ.2',this)">‡∏õ.2</button>
      <button onclick="changeClass('‡∏õ.3',this)">‡∏õ.3</button>
      <button onclick="changeClass('‡∏õ.4',this)">‡∏õ.4</button>
      <button onclick="changeClass('‡∏õ.5',this)">‡∏õ.5</button>
      <button onclick="changeClass('‡∏õ.6',this)">‡∏õ.6</button><br>
      <button onclick="changeClass('‡∏°.1',this)">‡∏°.1</button>
      <button onclick="changeClass('‡∏°.2',this)">‡∏°.2</button>
      <button onclick="changeClass('‡∏°.3',this)">‡∏°.3</button>
      <button onclick="changeClass('‡∏°.4',this)">‡∏°.4</button>
      <button onclick="changeClass('‡∏°.5',this)">‡∏°.5</button>
      <button onclick="changeClass('‡∏°.6',this)">‡∏°.6</button>
    </div>
  </div>

  <!-- ‡∏á‡∏≤‡∏ô -->
  <div class="card">
    <div style="display:flex;justify-content:space-between">
      <h4>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</h4>
      <button class="btn btn-add" onclick="addAssignment()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
    </div>
    <div id="assignmentList"></div>
  </div>
</div>

<!-- ‡∏Ç‡∏ß‡∏≤ -->
<div class="card">
  <div style="display:flex;justify-content:space-between">
    <h4>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
    <button class="btn btn-add" onclick="addStudent()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  </div>

  <table>
    <thead>
      <tr id="tableHead"></tr>
    </thead>
    <tbody id="students"></tbody>
  </table>
</div>

</div>

<script>
let currentClass = '‡∏õ.1';
let assignments = [];

/* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏±‡πâ‡∏ô */
function changeClass(cls, btn){
  currentClass = cls;
  document.getElementById('classTitle').innerText = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô: ${cls}`;
  document.querySelectorAll('.levels button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  loadAll();
}

/* ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
async function loadAll(){
  await loadAssignments();
  await loadStudents();
}

/* ‡∏á‡∏≤‡∏ô */
async function loadAssignments(){
  const res = await fetch(`http://localhost:3000/api/assignments?class=${currentClass}`);
  assignments = await res.json();

  const list = document.getElementById('assignmentList');
  list.innerHTML = '';

  assignments.forEach(a=>{
    list.innerHTML += `
      <div class="assign-item">
        <div>${a.name}<br><small>${a.max_score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</small></div>
        <button class="btn btn-del" onclick="deleteAssignment(${a.id})">üóëÔ∏è</button>
      </div>
    `;
  });

  const head = document.getElementById('tableHead');
  head.innerHTML = `
    <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
    <th>‡∏£‡∏´‡∏±‡∏™</th>
    <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
  `;

  assignments.forEach(a=>{
    head.innerHTML += `<th>${a.name}</th>`;
  });

  head.innerHTML += `<th>%</th><th>‡πÄ‡∏Å‡∏£‡∏î</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>`;
}

/* ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô */
async function loadStudents(){
  const res = await fetch(`http://localhost:3000/api/students?class=${currentClass}`);
  const data = await res.json();
  const tb = document.getElementById('students');
  tb.innerHTML = '';

  data.forEach((s,i)=>{
    let row = `
      <tr>
        <td>${i+1}</td>
        <td>${s.code}</td>
        <td>${s.name}</td>
    `;

    assignments.forEach(a=>{
      const sc = s.scores.find(x=>x.id===a.id);
      row += `
        <td>
          <input class="score" value="${sc?.score||0}"
            onchange="saveScore(${s.id},${a.id},this.value)">
        </td>`;
    });

    row += `
      <td>${s.percent}%</td>
      <td><span class="grade ${s.grade}">${s.grade}</span></td>
      <td><button class="btn btn-del" onclick="delStudent(${s.id})">üóëÔ∏è</button></td>
      </tr>`;
    tb.innerHTML += row;
  });
}

/* CRUD */
async function saveScore(student_id, assignment_id, score){
  await fetch('http://localhost:3000/api/scores',{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ student_id, assignment_id, score })
  });
}

async function addAssignment(){
  const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô");
  const max = prompt("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°");
  if(!name || !max) return;

  await fetch('http://localhost:3000/api/assignments',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ name, max_score:max, className:currentClass })
  });

  loadAll(); // üî• ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ loadAssignments()
}

async function deleteAssignment(id){
  if(!confirm("‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) return;
  await fetch(`http://localhost:3000/api/assignments/${id}`,{method:'DELETE'});
  loadAssignments();
}

async function addStudent(){
  const code = prompt("‡∏£‡∏´‡∏±‡∏™");
  const name = prompt("‡∏ä‡∏∑‡πà‡∏≠");
  if(!code||!name) return;
  await fetch('http://localhost:3000/api/students',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({code,name,className:currentClass})
  });
  loadStudents();
}

async function delStudent(id){
  if(!confirm("‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô?")) return;
  await fetch(`http://localhost:3000/api/students/${id}`,{method:'DELETE'});
  loadStudents();
}

loadAll();
</script>

</body>
</html>
