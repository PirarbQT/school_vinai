<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:'Prompt',sans-serif}
body{margin:0;background:#f3f6f9}

/* ===== Header ===== */
.header{
  background:#24384d;color:#fff;
  padding:14px 24px;
  display:flex;justify-content:space-between;align-items:center
}
.actions button{
  margin-left:6px;border:none;padding:6px 12px;
  border-radius:6px;color:#fff;cursor:pointer
}
.btn-add{background:#3b82f6}
.btn-edit{background:#f59e0b}
.btn-del{background:#ef4444}
.btn-room{background:#10b981}

/* ===== Filter ===== */
.filter{
  background:#fff;margin:16px;padding:12px;border-radius:8px;
  display:grid;grid-template-columns:repeat(6,1fr);gap:10px
}
.filter label{font-size:12px;color:#64748b}
.filter select{padding:6px;border:1px solid #cbd5e1;border-radius:6px}

/* ===== Table ===== */
.card{background:#fff;margin:16px;border-radius:8px;overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:center}
th.group{background:#e0f2fe}
th.total{background:#fff4c2}
th.grade{background:#dcfce7}
th.clickable{cursor:pointer}
input.score{width:60px;text-align:center}

/* selected */
#tbody tr.selected{background:#e0f2fe}

/* ===== Modal ===== */
.modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.4);
  justify-content:center;align-items:center
}
.modal-box{
  background:#fff;padding:16px;border-radius:10px;width:360px
}
.modal-box h3{margin-top:0}
.modal-box input,.modal-box select{
  width:100%;padding:6px;margin-bottom:10px
}
/* ===== Layout ===== */
.layout{
  display:flex;
  min-height:100vh;
}

/* ===== Sidebar ===== */
.sidebar{
  width:220px;
  background:#2f2f2f;
  color:#fff;
  display:flex;
  flex-direction:column;
}

.sidebar-header{
  padding:16px;
  font-size:18px;
  font-weight:bold;
  text-align:center;
  background:#1f2937;
  border-bottom:1px solid #374151;
}

.sidebar-menu{
  padding:10px;
}

.sidebar-menu .menu{
  display:block;
  padding:10px 12px;
  margin-bottom:6px;
  color:#fff;
  text-decoration:none;
  border-radius:6px;
  background:#374151;
  font-size:14px;
}

.sidebar-menu .menu:hover{
  background:#4b5563;
}

.sidebar-menu .menu.active{
  background:#2563eb;
}

/* ===== Content ===== */
.content{
  flex:1;
  background:#f3f6f9;
}

</style>
</head>
<body>
<div class="layout">

  <!-- ===== Sidebar ===== -->
  <aside class="sidebar">
    <div class="sidebar-header">
      üéì ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
    </div>

    <nav class="sidebar-menu">
      <a href="score.html" class="menu active">üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</a>
      <a href="grade.html" class="menu">üßÆ ‡∏ï‡∏±‡∏î‡πÄ‡∏Å‡∏£‡∏î</a>
    </nav>
  </aside>
  <main class="content">
<!-- ===== Header ===== -->
<div class="header">
  <div>üéì ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
  <div class="actions">
    <button class="btn-add" onclick="openAddStudent()">‚ûï ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
    <button class="btn-add" onclick="openAddItem()">‚ûï ‡∏á‡∏≤‡∏ô</button>
    <button class="btn-room" onclick="openAddRoom()">‚ûï ‡∏´‡πâ‡∏≠‡∏á</button>
    <button class="btn-edit" onclick="openEditStudent()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
    <button class="btn-del" onclick="deleteStudent()">üóë ‡∏•‡∏ö</button>
  </div>
</div>

<!-- ===== Filter ===== -->
<div class="filter">
  <div><label>‡∏õ‡∏µ</label><select id="year"></select></div>
  <div><label>‡πÄ‡∏ó‡∏≠‡∏°</label><select id="semester"></select></div>
  <div><label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label><select id="grade"></select></div>
  <div><label>‡∏´‡πâ‡∏≠‡∏á</label><select id="room"></select></div>
  <div><label>‡∏ß‡∏¥‡∏ä‡∏≤</label><select id="subject"></select></div>
</div>

<!-- ===== Table ===== -->
<div class="card">
<table>
<thead>
<tr id="groupHead"></tr>
<tr id="itemHead"></tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- ===== Student Modal ===== -->
<div class="modal" id="studentModal">
  <div class="modal-box">
    <h3 id="studentTitle"></h3>
    <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
    <input id="stdCode">
    <label>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
    <input id="stdName">
    <div style="text-align:right">
      <button onclick="closeStudent()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button onclick="saveStudent()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- ===== Room Modal ===== -->
<div class="modal" id="roomModal">
  <div class="modal-box">
    <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á</h3>
    <label>‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á</label>
    <input id="roomNo" type="number">
    <div style="text-align:right">
      <button onclick="closeRoom()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button onclick="saveRoom()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- ===== Score Item Modal ===== -->
<div class="modal" id="itemModal">
  <div class="modal-box">
    <h3 id="itemTitle"></h3>
    <label>‡∏ä‡∏∑‡πà‡∏≠</label>
    <input id="itemName">
    <label>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°</label>
    <input id="itemMax" type="number">
    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
    <select id="itemType"></select>

    <div style="display:flex;justify-content:space-between">
      <button id="deleteItemBtn"
        style="display:none;background:#ef4444;color:#fff"
        onclick="deleteItem()">üóë ‡∏•‡∏ö‡∏á‡∏≤‡∏ô</button>

      <div>
        <button onclick="closeItem()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button onclick="saveItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>
</div>

<script>
const API="http://localhost:3000/api";
let items=[], selectedStudent=null, editItemId=null;

/* ===== META ===== */
async function loadMeta(){
  const m = await fetch(API+"/meta").then(r=>r.json());

  year.innerHTML = m.years.map(x=>`<option value="${x.id}">${x.year}</option>`).join('');
  semester.innerHTML = m.semesters.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
  grade.innerHTML = m.grades.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
  subject.innerHTML = m.subjects.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');

  /* ‡πÇ‡∏´‡∏•‡∏î score types */
  const scoreTypes = m.score_types;

itemType.innerHTML = scoreTypes.map(
  t => `<option value="${t.id}">${t.name}</option>`
).join('');
}

/* ===== ROOMS ===== */
grade.onchange = async()=>{
  const r = await fetch(`${API}/rooms?grade_id=${grade.value}`).then(r=>r.json());
  room.innerHTML = r.length
    ? r.map(x=>`<option value="${x.id}">${x.room_no}</option>`).join('')
    : '';
  loadAll();
};

['year','semester','room','subject'].forEach(id=>{
  document.getElementById(id).addEventListener('change',loadAll);
});

/* ===== LOAD ===== */
async function loadAll(){
  if(!grade.value||!room.value||!year.value||!subject.value||!semester.value) return;

  items = await fetch(
    `${API}/score-items?grade_id=${grade.value}&subject_id=${subject.value}&academic_year_id=${year.value}&semester_id=${semester.value}`
  ).then(r=>r.json());

  renderHead();

  const students = await fetch(
    `${API}/students?grade_id=${grade.value}&room_id=${room.value}&academic_year_id=${year.value}&subject_id=${subject.value}&semester_id=${semester.value}`
  ).then(r=>r.json());

  renderBody(students);
}

/* ===== TABLE ===== */
function renderHead(){
  if(items.length===0){
    groupHead.innerHTML = `
      <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
      <th>‡∏ä‡∏∑‡πà‡∏≠</th>
      <th class="group">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
      <th class="total">‡∏£‡∏ß‡∏°</th>
      <th class="grade">‡πÄ‡∏Å‡∏£‡∏î</th>`;
    itemHead.innerHTML='';
    return;
  }

  const groups={};
items.forEach(i=>{
  const groupName = i.type_name || "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";   // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  groups[groupName] = groups[groupName] || [];
  groups[groupName].push(i);
});

  groupHead.innerHTML=`
    <th rowspan="2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
    <th rowspan="2">‡∏ä‡∏∑‡πà‡∏≠</th>
    ${Object.keys(groups).map(
      g=>`<th colspan="${groups[g].length}" class="group">${g}</th>`
    ).join('')}
    <th rowspan="2" class="total">‡∏£‡∏ß‡∏°</th>
    <th rowspan="2" class="grade">‡πÄ‡∏Å‡∏£‡∏î</th>
  `;

  itemHead.innerHTML=Object.values(groups).flat().map(
    i=>`<th class="clickable"
      onclick="openEditItem(${i.id},'${i.name}',${i.max_score},${i.type_id})">
      ${i.name}<br><small>${i.max_score}</small>
    </th>`
  ).join('');
}

function renderBody(data){
  tbody.innerHTML='';
  data.forEach(s=>{
    const tr=document.createElement('tr');
    tr.onclick=()=>{
      document.querySelectorAll('#tbody tr').forEach(x=>x.classList.remove('selected'));
      tr.classList.add('selected');
      selectedStudent=s;
    };
    tr.innerHTML=`
      <td>${s.code}</td>
      <td style="text-align:left">${s.name}</td>
      ${items.map(it=>`
        <td><input class="score"
          value="${s.scores[it.id]||0}"
          onchange="saveScore(${s.id},${it.id},this.value)">
        </td>`).join('')}
      <td>${s.percent}</td>
      <td>${s.grade}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===== SCORE ===== */
async function saveScore(student_id,score_item_id,score){
  await fetch(API+"/scores",{
    method:"PUT",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({student_id,score_item_id,score})
  });
  loadAll();
}

/* ===== STUDENT ===== */
function openAddStudent(){
  if(!room.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô");
  selectedStudent=null;
  studentTitle.innerText="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
  stdCode.value=''; stdName.value='';
  studentModal.style.display='flex';
}
function openEditStudent(){
  if(!selectedStudent) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
  studentTitle.innerText="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
  stdCode.value=selectedStudent.code;
  stdName.value=selectedStudent.name;
  studentModal.style.display='flex';
}
async function saveStudent(){
  const payload={
    code:stdCode.value,
    name:stdName.value,
    grade_id:grade.value,
    room_id:room.value,
    academic_year_id:year.value
  };
  const url=selectedStudent?`${API}/students/${selectedStudent.id}`:`${API}/students`;
  const method=selectedStudent?"PUT":"POST";
  await fetch(url,{
    method,
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  closeStudent(); loadAll();
}
async function deleteStudent(){
  if(!selectedStudent) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
  if(!confirm("‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô?")) return;
  await fetch(`${API}/students/${selectedStudent.id}`,{method:"DELETE"});
  selectedStudent=null; loadAll();
}
function closeStudent(){ studentModal.style.display='none'; }

/* ===== ROOM ===== */
function openAddRoom(){
  if(!grade.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô");
  roomNo.value='';
  roomModal.style.display='flex';
}
async function saveRoom(){
  await fetch(API+"/rooms",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({grade_id:grade.value,room_no:roomNo.value})
  });
  closeRoom();
  grade.onchange();
}
function closeRoom(){ roomModal.style.display='none'; }

/* ===== ITEM ===== */
function openAddItem(){
  if(
    !year.value ||
    !semester.value ||   // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
    !grade.value ||
    !subject.value
  ){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏õ‡∏µ / ‡πÄ‡∏ó‡∏≠‡∏° / ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô / ‡∏ß‡∏¥‡∏ä‡∏≤ ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô");
    return;
  }

  editItemId = null;
  itemTitle.innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô";
  itemName.value = '';
  itemMax.value = '';
  deleteItemBtn.style.display = 'none';
  itemModal.style.display = 'flex';
}

function openEditItem(id,name,max,type){
  editItemId=id;
  itemTitle.innerText="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô";
  itemName.value=name;
  itemMax.value=max;
  itemType.value=type;
  deleteItemBtn.style.display='inline-block';
  itemModal.style.display='flex';
}
async function deleteItem(){
  if(!editItemId) return;
  if(!confirm("‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ? ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢")) return;
  await fetch(`${API}/score-items/${editItemId}`,{method:"DELETE"});
  closeItem(); loadAll();
}
async function saveItem(){
  const payload={
    name:itemName.value,
    max_score:itemMax.value,
    type_id:itemType.value,
    grade_id:grade.value,
    subject_id:subject.value,
    academic_year_id:year.value,
    semester_id:semester.value
  };
  const url=editItemId?`${API}/score-items/${editItemId}`:`${API}/score-items`;
  const method=editItemId?"PUT":"POST";
  await fetch(url,{
    method,
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
  closeItem(); loadAll();
}
function closeItem(){ itemModal.style.display='none'; }

window.addEventListener("storage", (e) => {
  if(e.key === "GRADE_UPDATED"){
    loadAll(); // recalculates grade ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  }
});


loadMeta();
</script>
  </main>

</div>
</body>
</html>
